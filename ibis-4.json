{"kind":"Notebook","sha256":"27a9232d69e1e1285bad03ae0b3dcec4a1b7cc2b6de62dbb7fb35d108cb38dc0","slug":"ibis-4","location":"/reading/07-ibis-4.ipynb","dependencies":[],"frontmatter":{"title":"ibis + seaborn.objects: Data Exploration","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"MIT","url":"https://opensource.org/licenses/MIT","name":"MIT License","free":true,"osi":true}},"github":"https://github.com/espm-157/website","exports":[{"format":"ipynb","filename":"07-ibis-4.ipynb","url":"/build/07-ibis-4-896ff4dfd134186969bae313759f4a9c.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Learning Goals","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Oo6Kos4vdk"}],"identifier":"learning-goals","label":"Learning Goals","html_id":"learning-goals","implicit":true,"key":"zLonhlpvrB"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"We are now ready to start assembling the information we have learned from our initial exploration and bring together our skills with ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"nR0UMrWOHZ"},{"type":"inlineCode","value":"ibis","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"onSawu66YO"},{"type":"text","value":" and ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"RP8EWB42oi"},{"type":"inlineCode","value":"seaborn.objects","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"CmdCLGV3rC"},{"type":"text","value":".","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"dQWnF2EI0p"}],"key":"a7bwIPb6AB"}],"key":"HYJRTntWKU"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"import ibis\nfrom ibis import _\nimport ibis.selectors as s\nimport seaborn.objects as so \n\ncon = ibis.duckdb.connect()","key":"z5PQ8MjYeu"},{"type":"output","id":"H_WfTPlGqtqePyeNrlE9v","data":[],"key":"lKl6G1XUzW"}],"key":"jsMKprQCv0"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"base_url = \"https://huggingface.co/datasets/cboettig/ram_fisheries/resolve/main/v4.65/\"\nstock = con.read_csv(base_url + \"stock.csv\", nullstr=\"NA\")\ntimeseries = con.read_csv(base_url + \"timeseries.csv\", nullstr=\"NA\")","key":"A2i03exLyC"},{"type":"output","id":"EGx6yXqCdi0QEVpmb3B8P","data":[],"key":"yivBjY75Ci"}],"key":"En5s5D1tYt"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Last time we reached the conclusion that we wanted to average across multiple assessments:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XifecwAdKa"}],"key":"eH4khm10m4"}],"key":"WPXYQoSX46"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"cod_stocks = (\n  timeseries\n  .join(stock, \"stockid\")\n  .filter(_.tsid == \"TCbest-MT\")\n  .filter(_.commonname == \"Atlantic cod\")\n  .group_by(_.tsyear, _.stockid, _.primary_country, _.primary_FAOarea)\n  .agg(catch = _.tsvalue.mean())\n)\n","key":"xluBPvBl6V"},{"type":"output","id":"xpSiC51G691t4etfS6VTd","data":[],"key":"SvDhdvkpUD"}],"key":"m1tBAnNlrF"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This is great, but even after aggregating the assessments, we have a lot of individual cod stocks in various locations:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zqIqGIq5cz"}],"key":"EZ22HqeYRA"}],"key":"lqrhytkCOp"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"(\n    so.Plot(cod_stocks, \n        x = \"tsyear\",\n            y=\"catch\",\n            color = \"stockid\")\n    .add(so.Lines(linewidth=3))\n    .layout(size=(10, 6))\n)","key":"p2pBXnT90c"},{"type":"output","id":"QcyWaeeSXfQoT5D08_3o0","data":[{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"6c5f624c5df04d878f5988cc4e1a11b5\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"FloatProgress(value=0.0, layout=Layout(width='auto'), style=ProgressStyle(bar_color='black'))","content_type":"text/plain"}}},{"output_type":"execute_result","execution_count":16,"metadata":{"image/png":{"height":558.875,"width":954.125}},"data":{"image/png":{"content_type":"image/png","hash":"55e7564f61ba8af028355005ec0c8156","path":"/build/55e7564f61ba8af028355005ec0c8156.png"},"text/plain":{"content":"<seaborn._core.plot.Plot at 0x7477365ef8f0>","content_type":"text/plain"}}}],"key":"ca8MCD3P5k"}],"key":"oFPiBB8twX"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Our good friend, the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"V6Upz6WqEH"},{"type":"inlineCode","value":"COD2J3KL","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RvkGkxPEvy"},{"type":"text","value":" series shows up with it’s remarkable declines, but what’s going on with those highly variable but very large catches?  This will obviously impact our assessment of whether or not the species as a whole has collapsed.  This is too many stocks to easily explore, let’s try breaking this out by at the by country:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WB1DcRxI72"}],"key":"zoTQ6nASGn"}],"key":"ITv5mlfo4C"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"(\n    so.Plot(cod_stocks, \n            x = \"tsyear\", \n            y=\"catch\", \n            color = \"stockid\",\n            group = \"primary_country\")\n    .add(so.Lines(linewidth=3))\n    .facet(\"primary_country\", wrap = 6)\n    .layout(size=(16, 10))\n)","key":"Z6OdfpHtiE"},{"type":"output","id":"wcJeBDprH2axjqfPRnlJ2","data":[{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"4e9d4d25a22f4476af83029a114514f6\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"FloatProgress(value=0.0, layout=Layout(width='auto'), style=ProgressStyle(bar_color='black'))","content_type":"text/plain"}}},{"output_type":"execute_result","execution_count":5,"metadata":{"image/png":{"height":802.8249999999999,"width":1425.875}},"data":{"image/png":{"content_type":"image/png","hash":"71c80c3dd032675c9e4a18da632bf2cf","path":"/build/71c80c3dd032675c9e4a18da632bf2cf.png"},"text/plain":{"content":"<seaborn._core.plot.Plot at 0x74773b54a0f0>","content_type":"text/plain"}}}],"key":"gU1ZQGv2o8"}],"key":"Okrthj1LCO"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Note in the country-based graphs, several countries have multiple stocks.  Norway and Canada stand out for the largest harvests.  The ‘grammar of graphics’ in Seaborn objects makes it easy to quickly visually explore the data along different dimensions.  For instance, we can divide stocks by primary FAO Area instead of country with a single change:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SqJj6SNKtp"}],"key":"bzSRHWTMQs"}],"key":"d5pMAr1jBR"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"(\n    so.Plot(cod_stocks, \n            x = \"tsyear\", \n            y=\"catch\", \n            color = \"stockid\",\n            group = \"primary_FAOarea\")\n    .add(so.Lines(linewidth=3))\n    .facet(\"primary_FAOarea\")\n    .layout(size=(12, 8))\n)","key":"a5Xs9LmEsx"},{"type":"output","id":"Hm-4ghMj4hy0ejWwfSsCI","data":[{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"188d400fc755424695af42d178f9667f\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"FloatProgress(value=0.0, layout=Layout(width='auto'), style=ProgressStyle(bar_color='black'))","content_type":"text/plain"}}},{"output_type":"execute_result","execution_count":15,"metadata":{"image/png":{"height":639.625,"width":1113.925}},"data":{"image/png":{"content_type":"image/png","hash":"bd360198641417de374e78b7c26cdb59","path":"/build/bd360198641417de374e78b7c26cdb59.png"},"text/plain":{"content":"<seaborn._core.plot.Plot at 0x7477333b3c80>","content_type":"text/plain"}}}],"key":"QJYSFb3y4H"}],"key":"q81DlzSkcP"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We have visually grouped the data into the two parts of the globe where Atlantic Cod are found: “Western North-Atlantic” (FAO area 21) and “Eastern North-Atlantic” (area 27).  While we see declines in some Eastern stocks, the pattern in the West is much more dramatic.  If we want to consider the fate of Western Atlantic Cod as a whole, we can add up all these individual stocks to get a picture for the entire FAO Region.  We call the resulting table ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aePkFcBmGa"},{"type":"inlineCode","value":"cod_fao","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dIrpKi6ouK"},{"type":"text","value":" because now it no longer reflects individual stocks, we have summed all the individual stocks up when we aggregated to the level of entire FAO regions.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BDyTxGeQLR"}],"key":"l3yrVsfyoK"}],"key":"eVBcV59BZo"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"cod_fao = (cod_stocks\n   .group_by(_.tsyear, _.primary_FAOarea)\n   .agg(catch = _.catch.sum())\n)","key":"xHmxlRAYrn"},{"type":"output","id":"1mlXHdTXJOPqDSo-2zkx-","data":[],"key":"BMk4mWSaw9"}],"key":"OO5NfdyxEj"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"Once again we can get a visual sense of the resulting aggrecations.  ","key":"cYdOOKtixh"},{"type":"output","id":"i2w_BW_-bca5XncPUdvOK","data":[],"key":"YaifhmpKBm"}],"key":"D4leapepVy"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"(\n    so.Plot(cod_fao, \n            x = \"tsyear\", \n            y=\"catch\")\n    .add(so.Lines(linewidth=3))\n    .facet(\"primary_FAOarea\")\n)","key":"k4NbizM1kM"},{"type":"output","id":"Cset0iEPIf3EB0Oo8RxuL","data":[{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"f582757d4688472e9f3ab514208a8193\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"FloatProgress(value=0.0, layout=Layout(width='auto'), style=ProgressStyle(bar_color='black'))","content_type":"text/plain"}}},{"output_type":"execute_result","execution_count":17,"metadata":{"image/png":{"height":378.25,"width":509.15}},"data":{"image/png":{"content_type":"image/png","hash":"725fd50215517704893cfe01a468a221","path":"/build/725fd50215517704893cfe01a468a221.png"},"text/plain":{"content":"<seaborn._core.plot.Plot at 0x74773337de50>","content_type":"text/plain"}}}],"key":"SxJf3r4DBI"}],"key":"S1h2RYoNYO"}],"key":"lAPK0boQeG"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"ibis mutates and aggregates","url":"/ibis-3","group":"Textbook"}}},"domain":"http://localhost:3000"}