{"kind":"Notebook","sha256":"b4e8bcd077fc53e388610f0bb468e80727b7c774a2ce0f94d5141c30fbf88f11","slug":"ibis-3","location":"/reading/06-ibis-3.ipynb","dependencies":[],"frontmatter":{"title":"ibis mutates and aggregates","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"MIT","url":"https://opensource.org/licenses/MIT","name":"MIT License","free":true,"osi":true}},"github":"https://github.com/espm-157/website","exports":[{"format":"ipynb","filename":"06-ibis-3.ipynb","url":"/website/build/06-ibis-3-0784295ecb55314da1c5224153635f14.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Learning Goals","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"EfuoTRsEKO"}],"identifier":"learning-goals","label":"Learning Goals","html_id":"learning-goals","implicit":true,"key":"FkpwwiAUkJ"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"use ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"gXoGrJCNXw"},{"type":"inlineCode","value":"group_by()","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"J2TzbP1WWG"},{"type":"text","value":" and ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"bWUvR0VLkd"},{"type":"inlineCode","value":"aggregate()","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"AsNE8bCFZx"},{"type":"text","value":" patterns to summarize data","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"xAaDFDf7as"}],"key":"nLfgOxwD4S"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"use ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"RtQJDuVt52"},{"type":"inlineCode","value":"order_by()","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"CWHnm14Uvn"},{"type":"text","value":" to arrange rows by one or more columns.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"zoSDmWjITA"}],"key":"MDgz3rPOVM"}],"key":"sxOT4s55cr"}],"key":"EcWa8gQCB7"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"import ibis\nfrom ibis import _\nimport ibis.selectors as s\n\ncon = ibis.duckdb.connect()","key":"stfMWqCmPd"},{"type":"output","id":"UqzceQHuNSK6ylUjdZA3l","data":[],"key":"F13VpFtLq3"}],"key":"ycSYNp7S8t"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"base_url = \"https://huggingface.co/datasets/cboettig/ram_fisheries/resolve/main/v4.65/\"\n\nstock = con.read_csv(base_url + \"stock.csv\", nullstr=\"NA\")\ntimeseries = con.read_csv(base_url + \"timeseries.csv\", nullstr=\"NA\")\nassessment = con.read_csv(base_url + \"assessment.csv\", nullstr=\"NA\")\n","key":"WQgN6iI54Q"},{"type":"output","id":"i9yqogs-AIIiI8nHuyfZa","data":[],"key":"iT4xBM40CG"}],"key":"xvtwygjqkE"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Stock “assessments”","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pd3HUKciwe"}],"identifier":"stock-assessments","label":"Stock “assessments”","html_id":"stock-assessments","implicit":true,"key":"WPoRCAKIWA"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The next thing we need to know is a stock assessment.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"aCvThpXcUT"}],"key":"RJ75VfUcH6"}],"key":"NAPOsjL2Sx"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"assessment","key":"E8qkVSCapY"},{"type":"output","id":"90oDINVur9Yd8ajVpVVX7","data":[{"output_type":"execute_result","execution_count":3,"metadata":{},"data":{"text/html":{"content":"<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">DatabaseTable: ibis_read_csv_inv2bebb7vhktagb64s6mhgzaa\n  assessid       string\n  assessorid     string\n  stockid        string\n  stocklong      string\n  recorder       string\n  daterecorded   timestamp(6)\n  dateloaded     timestamp(6)\n  assessyear     string\n  assesssource   string\n  contacts       string\n  notes          string\n  pdffile        string\n  assess         int64\n  refpoints      int64\n  assessmethod   string\n  assesscomments string\n  xlsfilename    string\n  mostrecent     int64\n</pre>\n","content_type":"text/html"},"text/plain":{"content":"DatabaseTable: ibis_read_csv_inv2bebb7vhktagb64s6mhgzaa\n  assessid       string\n  assessorid     string\n  stockid        string\n  stocklong      string\n  recorder       string\n  daterecorded   timestamp(6)\n  dateloaded     timestamp(6)\n  assessyear     string\n  assesssource   string\n  contacts       string\n  notes          string\n  pdffile        string\n  assess         int64\n  refpoints      int64\n  assessmethod   string\n  assesscomments string\n  xlsfilename    string\n  mostrecent     int64","content_type":"text/plain"}}}],"key":"MqyaEzXV62"}],"key":"eikoPMKnDW"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Are some ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FtRVt6SQkI"},{"type":"inlineCode","value":"stockid","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"h0NaE3p92k"},{"type":"text","value":"s assessed multiple times? One intuitive idea is to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Nc2kRKe1Ku"},{"type":"inlineCode","value":"filter()","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tk5vANg9XG"},{"type":"text","value":" for a single stockid, and see if we get back multiple rows (multiple assessments).  Let’s take a look at “COD2J3KL”:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QL2vMHSdBB"}],"key":"N5BaLAJTJX"}],"key":"OXGgrkYugi"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"(assessment\n .filter(_.stockid == \"COD2J3KL\")\n .select(_.assessid, _.assessorid, _.stockid,\n         _.daterecorded, _.assessyear) # pick a subset of columns to focus on\n .execute()\n)","key":"SbULSxiE6z"},{"type":"output","id":"x3JFP4AQOgbXSA5uzj-nP","data":[{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>assessid</th>\n      <th>assessorid</th>\n      <th>stockid</th>\n      <th>daterecorded</th>\n      <th>assessyear</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>DFO-COD2J3KL-1959-2014-WATSON</td>\n      <td>DFO</td>\n      <td>COD2J3KL</td>\n      <td>2016-02-25</td>\n      <td>1959-2014</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>DFO-NFLD-COD2J3KL-1850-2011-CHING</td>\n      <td>DFO-NFLD</td>\n      <td>COD2J3KL</td>\n      <td>2013-10-22</td>\n      <td>1850-2011</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>DFO-NFLD-COD2J3KL-1959-2018-ASHBROOK</td>\n      <td>DFO-NFLD</td>\n      <td>COD2J3KL</td>\n      <td>2019-06-20</td>\n      <td>1959-2018</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>DFO-NFLD-COD2J3KL-1959-2021-HIVELY</td>\n      <td>DFO-NFLD</td>\n      <td>COD2J3KL</td>\n      <td>2023-11-08</td>\n      <td>1959-2021</td>\n    </tr>\n  </tbody>\n</table>\n</div>","content_type":"text/html"},"text/plain":{"content":"                               assessid assessorid   stockid daterecorded  \\\n0         DFO-COD2J3KL-1959-2014-WATSON        DFO  COD2J3KL   2016-02-25   \n1     DFO-NFLD-COD2J3KL-1850-2011-CHING   DFO-NFLD  COD2J3KL   2013-10-22   \n2  DFO-NFLD-COD2J3KL-1959-2018-ASHBROOK   DFO-NFLD  COD2J3KL   2019-06-20   \n3    DFO-NFLD-COD2J3KL-1959-2021-HIVELY   DFO-NFLD  COD2J3KL   2023-11-08   \n\n  assessyear  \n0  1959-2014  \n1  1850-2011  \n2  1959-2018  \n3  1959-2021  ","content_type":"text/plain"}}}],"key":"TDt1Znr3fI"}],"key":"UHcW5JSLIk"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Indeed, it looks like their are four assessments of this stock, each conducted in different years and spanning different periods in time!  ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QojvN8QLxw"},{"type":"inlineCode","value":"filter()","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XpAAem1WTe"},{"type":"text","value":"ing for each possible stockid would be tedious though. These four assessments that correspond to this stockid","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FtcIFN72ye"}],"key":"nZUHwlhkvl"}],"key":"zjWUU8Ioea"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"(assessment\n .group_by(_.stockid)\n .agg(n=_.count())\n .execute()\n)","key":"ZSFjaRgwQQ"},{"type":"output","id":"THjcbntikKE0cWW9XNtN2","data":[{"output_type":"execute_result","execution_count":5,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>stockid</th>\n      <th>n</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>CSALMAKPSESCD</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>CSALMANVIKR</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>CSALMNORTONSD1</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>CSALMURSUSCL</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>CSALMYUKONRSR</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>1507</th>\n      <td>NPOUTVIa</td>\n      <td>2</td>\n    </tr>\n    <tr>\n      <th>1508</th>\n      <td>PLAIC7d</td>\n      <td>10</td>\n    </tr>\n    <tr>\n      <th>1509</th>\n      <td>PLAICIIIa</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>1510</th>\n      <td>POLLNS-VI-IIIa</td>\n      <td>11</td>\n    </tr>\n    <tr>\n      <th>1511</th>\n      <td>WHITIIIa</td>\n      <td>4</td>\n    </tr>\n  </tbody>\n</table>\n<p>1512 rows × 2 columns</p>\n</div>","content_type":"text/html"},"text/plain":{"content":"             stockid   n\n0      CSALMAKPSESCD   1\n1        CSALMANVIKR   1\n2     CSALMNORTONSD1   1\n3       CSALMURSUSCL   1\n4      CSALMYUKONRSR   1\n...              ...  ..\n1507        NPOUTVIa   2\n1508         PLAIC7d  10\n1509       PLAICIIIa   1\n1510  POLLNS-VI-IIIa  11\n1511        WHITIIIa   4\n\n[1512 rows x 2 columns]","content_type":"text/plain"}}}],"key":"zCHDlk5mve"}],"key":"v87SfjxeQv"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"order_by()","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LtElwHs2kH"}],"identifier":"order-by","label":"order_by()","html_id":"order-by","implicit":true,"key":"W42qeEr29C"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Which ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yhqWQGCg2w"},{"type":"inlineCode","value":"stockid","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ahHxzcwwe8"},{"type":"text","value":"s have the most assessments?  We can re-order the rows by different columns using the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"tDZxnSwEpx"},{"type":"inlineCode","value":"order_by()","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nRuMnVJ9Py"},{"type":"text","value":". (Changing the row order does not alter any individual row itself -- that would mess up the data.  Each row is moved as a unit).  By default, ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"EaINueUNv2"},{"type":"inlineCode","value":"order","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"l7z8KydSGQ"},{"type":"text","value":" is always ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"MomGNtrcNo"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"increasing","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FFQ80n8Ouq"}],"key":"AD0lGjnsqD"},{"type":"text","value":", smallest to largest, A to Z.  While that might be intuitive for dates or names, if we want to see which stocks have the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wfoayEMQR0"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"most","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"EQSIVfP6SA"}],"key":"K3CcyVQ3TO"},{"type":"text","value":" assessments, we need ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"fnsQ8SImuV"},{"type":"inlineCode","value":"n","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FmmevI76oB"},{"type":"text","value":" to be in descending order.  We indicate this by appending the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wNQ1CbMQhf"},{"type":"inlineCode","value":".desc()","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"VvnAyVV9Sk"},{"type":"text","value":" method to the column:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jXiOj6yzCS"}],"key":"n7600kAsdk"}],"key":"WR0KJwWoav"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"(assessment\n .group_by(_.stockid)\n .agg(n=_.count())\n .order_by(_.n.desc())\n .execute()\n)","key":"zrSOiVXpTN"},{"type":"output","id":"82CjeJjnywOCpVUSwsdWH","data":[{"output_type":"execute_result","execution_count":6,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>stockid</th>\n      <th>n</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>CODIIIaW-IV-VIId</td>\n      <td>12</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>SEELNSSA2</td>\n      <td>11</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>SPRAT22-32</td>\n      <td>11</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>PLAICNS</td>\n      <td>11</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>HERRNIRS</td>\n      <td>11</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>1507</th>\n      <td>CSALMSKAGR</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>1508</th>\n      <td>PSALMHHAMMAHC</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>1509</th>\n      <td>PSALMNISQPS</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>1510</th>\n      <td>PSALMSNOHPS</td>\n      <td>1</td>\n    </tr>\n    <tr>\n      <th>1511</th>\n      <td>SARDVII-VIIIabd</td>\n      <td>1</td>\n    </tr>\n  </tbody>\n</table>\n<p>1512 rows × 2 columns</p>\n</div>","content_type":"text/html"},"text/plain":{"content":"               stockid   n\n0     CODIIIaW-IV-VIId  12\n1            SEELNSSA2  11\n2           SPRAT22-32  11\n3              PLAICNS  11\n4             HERRNIRS  11\n...                ...  ..\n1507        CSALMSKAGR   1\n1508     PSALMHHAMMAHC   1\n1509       PSALMNISQPS   1\n1510       PSALMSNOHPS   1\n1511   SARDVII-VIIIabd   1\n\n[1512 rows x 2 columns]","content_type":"text/plain"}}}],"key":"wKlTsY1N7b"}],"key":"Pna6P2Tde1"}],"key":"zCztToTN3M"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"ibis Table Joins","url":"/ibis-2","group":"Textbook"},"next":{"title":"ibis + seaborn.objects: Data Exploration","url":"/ibis-4","group":"Textbook"}}},"domain":"http://localhost:3000"}