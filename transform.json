{"kind":"Notebook","sha256":"88d415a06bd81d63e70cd7ffb05bf429840deb9cb0163d1e75da37b7111562a0","slug":"transform","location":"/reading/04-transform.ipynb","dependencies":[],"frontmatter":{"title":"Transforming Data","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"MIT","url":"https://opensource.org/licenses/MIT","name":"MIT License","free":true,"osi":true}},"github":"https://github.com/espm-157/website","exports":[{"format":"ipynb","filename":"04-transform.ipynb","url":"/website/build/04-transform-115ac3f6e4ec18e63f29d64e89e876e6.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Tidy Data","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"N26cqzXfG3"}],"identifier":"tidy-data","label":"Tidy Data","html_id":"tidy-data","implicit":true,"key":"H80tCuEFbr"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Analysis-ready data, or ‘tidy data’, is a central concept in data science.  The term was coined by Hadley Wickham","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ToEwv5KK44"},{"type":"footnoteReference","identifier":"1","label":"1","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"number":1,"enumerator":"1","key":"XqDjBQvD5Y"},{"type":"text","value":" to describe best practices long known in the relational database community, specifically, conventions around formatting tabular data known as ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"R4U2zL9tMD"},{"type":"link","url":"https://en.wikipedia.org/wiki/Third_normal_form","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Cobb’s Third Normal Form","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"IqJtjAKHJX"}],"urlSource":"https://en.wikipedia.org/wiki/Third_normal_form","data":{"page":"Third_normal_form","wiki":"https://en.wikipedia.org/","lang":"en"},"internal":false,"protocol":"wiki","key":"DCbLjX9GFA"},{"type":"text","value":". In this form, each row represents an observation and each column represents a variable. These conventions allow us to leverage powerful software and techniques for data analysis and visualization more easily, as many such tools are designed with tidy data structures in mind.  However, wild-caught data often does not follow these rules. Consider this example of NASA data on land ice mass:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"kiwlyFZgsm"}],"key":"vXqAzpEVrA"},{"type":"footnoteDefinition","identifier":"1","label":"1","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Wickham (2014). Tidy data.  Journal of Statistical Software 14(10) DOI:10.18637/jss.v059.i10 ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"DpIxxaHJDr"},{"type":"link","url":"https://vita.had.co.nz/papers/tidy-data.pdf","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"https://​vita​.had​.co​.nz​/papers​/tidy​-data​.pdf","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"qEEgZnM3z0"}],"urlSource":"https://vita.had.co.nz/papers/tidy-data.pdf","key":"ijxu5Hdq50"}],"key":"zeGPyMMNFV"}],"number":1,"enumerator":"1","key":"sfwHSrKndK"}],"key":"Wq3dNUg5gj"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"import pandas as pd\n\ndf = pd.read_csv(\"http://climate.nasa.gov/system/internal_resources/details/original/499_GRN_ANT_mass_changes.csv\",\n                skiprows=10, names=['date', 'greenland', 'antarctica'])\ndf","key":"azppbYNCVS"},{"type":"output","id":"ZXr-NtMKgV-CPL4_bk9ub","data":[{"output_type":"execute_result","execution_count":1,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>date</th>\n      <th>greenland</th>\n      <th>antarctica</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>2002.29</td>\n      <td>1490.68</td>\n      <td>967.20</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>2002.35</td>\n      <td>1485.69</td>\n      <td>978.55</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>2002.62</td>\n      <td>1286.84</td>\n      <td>512.02</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>2002.71</td>\n      <td>1257.85</td>\n      <td>858.85</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>2002.79</td>\n      <td>1257.17</td>\n      <td>693.87</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>135</th>\n      <td>2014.45</td>\n      <td>-1672.08</td>\n      <td>-1021.70</td>\n    </tr>\n    <tr>\n      <th>136</th>\n      <td>2014.62</td>\n      <td>-1985.59</td>\n      <td>-1067.84</td>\n    </tr>\n    <tr>\n      <th>137</th>\n      <td>2014.71</td>\n      <td>-2024.82</td>\n      <td>-780.87</td>\n    </tr>\n    <tr>\n      <th>138</th>\n      <td>2014.79</td>\n      <td>-1973.96</td>\n      <td>-904.38</td>\n    </tr>\n    <tr>\n      <th>139</th>\n      <td>2014.88</td>\n      <td>-1911.78</td>\n      <td>-1009.80</td>\n    </tr>\n  </tbody>\n</table>\n<p>140 rows × 3 columns</p>\n</div>","content_type":"text/html"},"text/plain":{"content":"        date  greenland  antarctica\n0    2002.29    1490.68      967.20\n1    2002.35    1485.69      978.55\n2    2002.62    1286.84      512.02\n3    2002.71    1257.85      858.85\n4    2002.79    1257.17      693.87\n..       ...        ...         ...\n135  2014.45   -1672.08    -1021.70\n136  2014.62   -1985.59    -1067.84\n137  2014.71   -2024.82     -780.87\n138  2014.79   -1973.96     -904.38\n139  2014.88   -1911.78    -1009.80\n\n[140 rows x 3 columns]","content_type":"text/plain"}}}],"key":"dkXUr96Xc1"}],"key":"iOoePq4rvP"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The column heading we have called ‘greenland’ is not a single variable (feature) being observed, but in fact a mashup of two different variables -- the ice mass (in gigatons) on the location of Greenland. (In the original data file it has the name ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VRuSbNXvEI"},{"type":"inlineCode","value":"Greenland mass (Gt)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rNxvqCAm5k"},{"type":"text","value":", which more clearly indicates this mash-up but does not follow our naming conventions.  Likewise the column called ‘antarctica’ again measures land ice mass, but at a different location.  A “tidy” version of this data would use one column to indicate location (Greenland or Antarctica) and another column to indicate ice mass at that location.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lzqyTvWXbB"}],"key":"LykkSMoPwp"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"To fix this, we need to ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"B8RSt0jFaU"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"pivot","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"okK27zbdFa"}],"key":"kv18HUdB8Q"},{"type":"text","value":" the data table into a “long” form, with a single column for ice mass and a single column for location.  While there are many ways to do this, we will rely on the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ApdlPysufJ"},{"type":"inlineCode","value":"ibis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"PKRpYC4fLu"},{"type":"text","value":" framework which provides one of the most consistent and powerful interfaces for tabular data operations.  We begin by loading the ibis library and establishing a “connection” to a backend engine.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qxSbuR6f6S"}],"key":"W9VmWtQgRm"}],"key":"ikxXZrOeP9"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"import ibis\nfrom ibis import selectors as s\ncon = ibis.duckdb.connect()","key":"vAaLOeUzAK"},{"type":"output","id":"IYDnj6sP4Dw7raoHkTO9j","data":[],"key":"sjDhnYN9MK"}],"key":"sIIn3GBxdf"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We add our pandas table to the ibis connection using the method ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"S0FWrNNLX7"},{"type":"inlineCode","value":"create_table","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Z8v1GQ6Pe9"},{"type":"text","value":".  This allows us to manipulate the table using ibis methods rather than pandas.  We will later see other ways to create ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"U5fAxwVS53"},{"type":"inlineCode","value":"ibis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"w1a8CNGfxg"},{"type":"text","value":" tables directly from a wide range of data other than pandas data.frames.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sCCZhJc2mk"}],"key":"KDucX5LFJh"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"We then use the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dzGxkslcKI"},{"type":"inlineCode","value":"pivot_longer()","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jeUXhD0Me7"},{"type":"text","value":" method to transform our data.  We use the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nkfrXE7vgb"},{"type":"inlineCode","value":"ibis.selectors","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"a92RHjMzb1"},{"type":"text","value":" methods to indicate which columns we are aggregating in the pivot.  Optionally, we indicate the name of the new column that will contain the previous column names (greenland, antarctica) and the name of the column that will contain the cell values (the ice mass).","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"C3xlgxlxnN"}],"key":"orFeBpDhmL"}],"key":"ACvXdocOKR"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"land_ice = (con\n .create_table(\"land_ice\", df, overwrite=True)\n .pivot_longer(s.any_of('greenland', 'antarctica'),\n               names_to= \"location\", values_to = \"ice_mass\")\n)\n\nland_ice.execute()","key":"Dp6gF14v2I"},{"type":"output","id":"P0yv2G1K3q5vHHwuCwLoR","data":[{"output_type":"execute_result","execution_count":3,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>date</th>\n      <th>location</th>\n      <th>ice_mass</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>2002.29</td>\n      <td>greenland</td>\n      <td>1490.68</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>2002.29</td>\n      <td>antarctica</td>\n      <td>967.20</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>2002.35</td>\n      <td>greenland</td>\n      <td>1485.69</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>2002.35</td>\n      <td>antarctica</td>\n      <td>978.55</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>2002.62</td>\n      <td>greenland</td>\n      <td>1286.84</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>275</th>\n      <td>2014.71</td>\n      <td>antarctica</td>\n      <td>-780.87</td>\n    </tr>\n    <tr>\n      <th>276</th>\n      <td>2014.79</td>\n      <td>greenland</td>\n      <td>-1973.96</td>\n    </tr>\n    <tr>\n      <th>277</th>\n      <td>2014.79</td>\n      <td>antarctica</td>\n      <td>-904.38</td>\n    </tr>\n    <tr>\n      <th>278</th>\n      <td>2014.88</td>\n      <td>greenland</td>\n      <td>-1911.78</td>\n    </tr>\n    <tr>\n      <th>279</th>\n      <td>2014.88</td>\n      <td>antarctica</td>\n      <td>-1009.80</td>\n    </tr>\n  </tbody>\n</table>\n<p>280 rows × 3 columns</p>\n</div>","content_type":"text/html"},"text/plain":{"content":"        date    location  ice_mass\n0    2002.29   greenland   1490.68\n1    2002.29  antarctica    967.20\n2    2002.35   greenland   1485.69\n3    2002.35  antarctica    978.55\n4    2002.62   greenland   1286.84\n..       ...         ...       ...\n275  2014.71  antarctica   -780.87\n276  2014.79   greenland  -1973.96\n277  2014.79  antarctica   -904.38\n278  2014.88   greenland  -1911.78\n279  2014.88  antarctica  -1009.80\n\n[280 rows x 3 columns]","content_type":"text/plain"}}}],"key":"Hr1TypY7dJ"}],"key":"DTxvii98Hb"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Note the use of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IwvXsLt4ZI"},{"type":"inlineCode","value":".execute()","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"erzOB1lmV9"},{"type":"text","value":" at the end of the ibis command to see the results.  ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Xd5dKzsumG"},{"type":"inlineCode","value":"ibis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ogu9REB8YO"},{"type":"text","value":" uses a sophisticated strategy called “lazy evaluation”, in which it does not actually run the code we provide until absolutely necessary.  While this feels cumbersome now, these small extra steps will pay big dividends for us when we move to big data sources that historically courses have needed to teach entirely different tools for.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HGe3I2X3uS"}],"key":"qpZzzx95sO"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Now that are data is ‘tidy’, some operations are much easier. For instance, plotting two lines, with a legend, merely requires the single aesthetic mapping of color to the location column: ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"iBhTkFKr5A"},{"type":"inlineCode","value":"color = \"location\"","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"oIvAnD5GBc"}],"key":"G4HnerduWp"}],"key":"Rcg3zKMSPc"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"import seaborn.objects as so\np = (so.Plot(land_ice, \n             x = \"date\", \n             y = \"ice_mass\", \n             color = \"location\")\n     .add(so.Line())\n    )\n\np","key":"DzacbdY2bK"},{"type":"output","id":"9XjHHTYBCKKzB8p4-qCm0","data":[{"output_type":"execute_result","execution_count":4,"metadata":{"image/png":{"height":378.25,"width":626.875}},"data":{"image/png":{"content_type":"image/png","hash":"a076fa876a358f45349f25d9264fb698","path":"/website/build/a076fa876a358f45349f25d9264fb698.png"},"text/plain":{"content":"<seaborn._core.plot.Plot at 0x757cf83ef860>","content_type":"text/plain"}}}],"key":"GL8sxrKRCz"}],"key":"hOFRUoOSlG"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We can map this additional column to different aesthetics just as easily.  This illustrates the value of well-structured data and abstract grammar for operating on it.  For instance, having subplots (facets) based on this data:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"D9KtUZYdVB"}],"key":"G8cV1VeKDe"}],"key":"dTLwFUFsL8"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"p.facet(\"location\")","key":"msmvpJY35X"},{"type":"output","id":"ab9S5RI-oHvwXJBPwt7vl","data":[{"output_type":"execute_result","execution_count":5,"metadata":{"image/png":{"height":378.25,"width":626.875}},"data":{"image/png":{"content_type":"image/png","hash":"8f2d7998fe9a196b87093a35a98c67a0","path":"/website/build/8f2d7998fe9a196b87093a35a98c67a0.png"},"text/plain":{"content":"<seaborn._core.plot.Plot at 0x757cf81022d0>","content_type":"text/plain"}}}],"key":"imSyK9NC9q"}],"key":"v72t52L4EN"}],"key":"mjhGPphErc"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Accessing Real World Data","url":"/data-access","group":"Textbook"},"next":{"title":"ibis Single Table Verbs","url":"/ibis-1","group":"Textbook"}}},"domain":"http://localhost:3000"}